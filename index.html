<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>115å¹´æ›¸è¨˜å®˜æ‰“å­—æ¸¬é©—å¡«å ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; touch-action: pan-x pan-y; }
        .container { background: white; padding: 20px 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 500px; position: relative; }
        h2 { text-align: center; color: #333; margin-top: 0; margin-bottom: 10px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; background-color: white; }
        input:focus, select:focus { border-color: #4CAF50; outline: none; }
        .btn-primary { width: 100%; padding: 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-primary:hover { background-color: #45a049; }
        .btn-secondary { width: 100%; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-info { width: 100%; padding: 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
        .btn-warning { width: 100%; padding: 10px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .readonly-field { background-color: #e9ecef; color: #495057; }
        .hidden { display: none !important; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .status-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .status-table th, .status-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .status-table th { background-color: #f2f2f2; }
        .scrollable-list { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #eee; }
        .hint { color: #666; font-size: 0.85em; text-align: center; line-height: 1.6; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="container" id="loginSection">
        <h2>ç™»å…¥æ¸¬é©—å ±åç³»çµ±</h2>
        <div class="form-group">
            <label>1. è¡¨å–®å¯†ç¢¼</label>
            <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥è¡¨å–®å¯†ç¢¼">
        </div>
        <div class="form-group">
            <label>2. AD å¸³è™Ÿ</label>
            <input type="text" id="adInput" placeholder="ä¾‹å¦‚: amigo12345678">
        </div>
        <div class="form-group">
            <label>3. æ¡ˆç®¡å¸³è™Ÿ (6ç¢¼)</label>
            <input type="text" id="caseInput" placeholder="ä¾‹å¦‚: 130000">
        </div>
        <button class="btn-primary" onclick="checkAuth()">é©—è­‰ä¸¦é€²å…¥</button>
        <p class="hint" style="margin-top: 15px;">
            é–‹æ”¾æ™‚é–“ï¼š115/02/18 08:00<br>
            æˆªæ­¢æ™‚é–“ï¼š115/02/20 17:00
        </p>
        <p id="loginMsg" style="color:red; text-align:center;"></p>
    </div>

    <div class="container hidden" id="closedSection">
        <h2 style="color: #dc3545;">è¡¨å–®å·²æˆªæ­¢</h2>
        <p style="text-align:center; color:#666;">ç›®å‰çš„å¡«å ±æ™‚é–“å·²çµæŸã€‚<br>å¦‚æœ‰ç–‘ç¾©ï¼Œè«‹è¯ç¹«#3216 è³‡è¨Šå·¥ç¨‹å¸« é¡§èŠ³ç¢©ã€‚</p>
    </div>

    <div class="container hidden" id="formSection">
        <button class="btn-info" onclick="toggleSection('querySection')">ğŸ” æŸ¥è©¢å¡«å ±ç‹€æ…‹</button>
        <h2>115å¹´æ›¸è¨˜å®˜æ‰“å­—æ¸¬é©—</h2>
        <div class="hint">
            è«‹ç¢ºèªæ‚¨çš„è³‡è¨Šä¸¦é¸æ“‡æ¸¬é©—æ™‚æ®µã€‚<br>
            âš ï¸ æ¯äººé™å¡«ä¸€æ¬¡ï¼Œé€å‡ºå¾Œç„¡æ³•ä¿®æ”¹ âš ï¸
        </div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">
        
        <form id="dataForm" onsubmit="handleFormSubmit(event)">
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="autoName" class="readonly-field" readonly>
            </div>
            <div class="form-group">
                <label>è‚¡åˆ¥ / è·ç¨±</label>
                <input type="text" id="autoInfo" class="readonly-field" readonly>
            </div>
            <div class="form-group">
                <label>é¸æ“‡æ¸¬é©—æ™‚æ®µ</label>
                <select id="timeSelect" required>
                    <option value="" disabled selected>è«‹é¸æ“‡æ™‚æ®µ...</option>
                    <option value="115/02/18 09:00-10:00">115/02/18 09:00-10:00</option>
                    <option value="115/02/18 10:00-11:00">115/02/18 10:00-11:00</option>
                    <option value="115/02/18 14:00-15:00">115/02/18 14:00-15:00</option>
                </select>
            </div>
            <div class="form-group">
                <label>å‚™è¨»</label>
                <input type="text" id="inputNote" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤è¨»è¨˜">
            </div>
            <button type="submit" id="submitBtn" class="btn-primary">ç¢ºèªä¸¦æäº¤</button>
        </form>
    </div>

    <div class="container hidden" id="querySection">
        <h2>æŸ¥è©¢å¡«å ±ç‹€æ…‹</h2>
        <div class="form-group">
            <label>é¸æ“‡å§“å</label>
            <select id="queryNameSelect">
                <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        <button class="btn-primary" onclick="queryStatus()">æŸ¥è©¢å€‹äºº</button>
        <button class="btn-warning" onclick="showAllStatus()">æŸ¥è©¢å…¨éƒ¨ç‹€æ…‹</button>
        <button class="btn-secondary" onclick="toggleSection('formSection')">è¿”å›å¡«å ±é é¢</button>

        <div id="allStatusContainer" class="hidden scrollable-list">
            <table class="status-table">
                <thead>
                    <tr><th>å§“å</th><th>å·²å¡«å ±</th></tr>
                </thead>
                <tbody id="statusTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="container hidden" id="thankYouSection">
        <h2 style="color: #28a745;">æäº¤æˆåŠŸï¼</h2>
        <p style="text-align:center;">æ‚¨é¸æ“‡çš„æ™‚é–“èˆ‡è³‡æ–™å·²è¨˜éŒ„å®Œæˆã€‚</p>
        <button class="btn-primary" onclick="location.reload()">å›åˆ°é¦–é </button>
    </div>

    <div id="loading" class="hidden">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>

    <script>
        var scriptURL = "https://script.google.com/macros/s/AKfycbwlQF0sxojJBuWHPb_S07mSIRjV4HRNw8mYPEOS9XFKKwRy2n7Ej8wSdIOLdl_cKWt8/exec"; // è«‹æ›´æ›ç‚ºæ‚¨çš„å¾Œç«¯ URL
        var allData = [];
        var userData = null;
        var OPEN_DATE = new Date("2026-02-18T08:00:00");
        var DEADLINE_DATE = new Date("2026-02-20T17:00:00");

        window.onload = function() {
            var now = new Date();
            if (now > DEADLINE_DATE) {
                showSection('closedSection');
            }
        };

        function checkAuth() {
    var pwd = document.getElementById('passwordInput').value;
    var ad = document.getElementById('adInput').value.trim();
    var caseId = document.getElementById('caseInput').value.trim();

    if (pwd !== 'SHU') {
        alert("è¡¨å–®å¯†ç¢¼éŒ¯èª¤");
        return;
    }

    document.getElementById('loading').classList.remove('hidden');

    // ä¿®æ­£é»ï¼šGET è«‹æ±‚ä¸æ‡‰åŠ  no-corsï¼Œå¦å‰‡ JSON æœƒè®Š null
    fetch(scriptURL + "?action=getList")
        .then(res => res.json())
        .then(data => {
            allData = data;
            // é©—è­‰é‚è¼¯
            userData = data.find(item => 
                item.ad.toLowerCase() === ad.toLowerCase() && 
                String(item.caseId) === caseId
            );

            if (userData) {
                setupForm();
                showSection('formSection');
            } else {
                document.getElementById('loginMsg').innerText = "ADå¸³è™Ÿæˆ–æ¡ˆç®¡å¸³è™Ÿä¸æ­£ç¢º";
            }
            document.getElementById('loading').classList.add('hidden');
        })
        .catch(err => {
            console.error(err);
            alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Script ç¶²å€æ˜¯å¦æ­£ç¢ºæˆ–å·²é–‹å•Ÿæ‰€æœ‰äººå­˜å–æ¬Šé™ã€‚");
            document.getElementById('loading').classList.add('hidden');
        });
}

        function setupForm() {
            document.getElementById('autoName').value = userData.name;
            document.getElementById('autoInfo').value = userData.section + " / " + userData.title;
            
            var qSelect = document.getElementById('queryNameSelect');
            qSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
            allData.forEach(item => {
                var opt = document.createElement('option');
                opt.value = item.name; opt.text = item.name;
                qSelect.appendChild(opt);
            });
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            if (document.activeElement) {
        document.activeElement.blur();
    }
            var time = document.getElementById('timeSelect').value;
            if (!time) { alert("è«‹é¸æ“‡æ¸¬é©—æ™‚æ®µï¼"); return; }

            if (confirm("ç¢ºèªæ™‚æ®µé¸æ“‡æ˜¯å¦æ­£ç¢ºï¼Ÿ\né¸æ“‡ï¼š" + time + "\n(é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹)")) {
                submitData(time);
            }
        }

        function submitData(selectedTime) {
            var btn = document.getElementById('submitBtn');
            btn.disabled = true;
            document.getElementById('loading').classList.remove('hidden');

            var now = new Date();
var rocYear = now.getFullYear() - 1911; // å–å¾—æ°‘åœ‹å¹´ (ä¾‹å¦‚ 115)
var timestamp = rocYear + "/" + 
                String(now.getMonth() + 1).padStart(2, '0') + "/" + 
                String(now.getDate()).padStart(2, '0') + " " + 
                String(now.getHours()).padStart(2, '0') + ":" + 
                String(now.getMinutes()).padStart(2, '0');;

            var payload = {
                name: userData.name,
                selectedTime: selectedTime,
                note: document.getElementById('inputNote').value,
                submitTime: timestamp,
                mark: "v"
            };

            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify(payload),
                mode: 'no-cors'
            }).then(() => {
                showSection('thankYouSection');
                document.getElementById('loading').classList.add('hidden');
            });
        }

        function showSection(id) {
            ['loginSection', 'closedSection', 'formSection', 'querySection', 'thankYouSection'].forEach(sec => {
                document.getElementById(sec).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function toggleSection(id) { showSection(id); }

        function queryStatus() {
            var name = document.getElementById('queryNameSelect').value;
            var found = allData.find(i => i.name === name);
            if (found && found.mark === "v") alert(name + " å·²å®Œæˆå¡«å ±ï¼");
            else alert(name + " å°šæœªå¡«å ±ã€‚");
        }

        function showAllStatus() {
            var tbody = document.getElementById('statusTableBody');
            tbody.innerHTML = "";
            allData.forEach(item => {
                var tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.name}</td><td>${item.mark === 'v' ? 'âœ”' : ''}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('allStatusContainer').classList.remove('hidden');
        }
    </script>
</body>
</html>
